/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PckInterfaces;

import PckConexion.ClsConexion;
import PckNegocio.ClsRaices;
import java.awt.Desktop;
import java.io.File;
import java.io.IOException;
import java.nio.file.CopyOption;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.sql.Connection;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import prymatricula.JTreeFile;

/**
 *
 * @author Kevin
 */
public class FrmFormato extends javax.swing.JInternalFrame {
    private String rutaDestino;
    private String rutaOrigen;
    private String rutaFormato;
    Connection con;
    File aux;
    /**
     * Creates new form FrmFormato
     */
    public FrmFormato() {
        initComponents();
        
        rutaFormato = cargarRaizFormato();
        if(cargarRaizFormato()!=null)
        {            
            File aux = new File(rutaFormato);   
            System.out.println(aux.getName()+" "+rutaFormato);
            actualizarArbolFormato(aux.getName(),rutaFormato);
        }
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        treFormato = new javax.swing.JTree();
        jPanel2 = new javax.swing.JPanel();
        btnDescargar = new javax.swing.JButton();
        jButton1 = new javax.swing.JButton();

        setTitle("Formatos de la Instituci√≥n");

        jPanel1.setBackground(new java.awt.Color(255, 255, 255));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel4.setBackground(new java.awt.Color(255, 255, 255));
        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Directorio de Formatos"));
        jPanel4.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        treFormato.setFont(new java.awt.Font("Droid Sans", 0, 11)); // NOI18N
        javax.swing.tree.DefaultMutableTreeNode treeNode1 = new javax.swing.tree.DefaultMutableTreeNode("root");
        treFormato.setModel(new javax.swing.tree.DefaultTreeModel(treeNode1));
        treFormato.addTreeSelectionListener(new javax.swing.event.TreeSelectionListener() {
            public void valueChanged(javax.swing.event.TreeSelectionEvent evt) {
                treFormatoValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(treFormato);

        jPanel4.add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 30, 300, 370));

        jPanel1.add(jPanel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 30, 360, 420));

        jPanel2.setBackground(new java.awt.Color(255, 255, 255));
        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Opciones"));
        jPanel2.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        btnDescargar.setFont(new java.awt.Font("Droid Sans", 0, 11)); // NOI18N
        btnDescargar.setText("<html> <p align=center>Descargar</p> <p align=center>Archivo</p> </html>");
        btnDescargar.setEnabled(false);
        btnDescargar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDescargarActionPerformed(evt);
            }
        });
        jPanel2.add(btnDescargar, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 50, -1, -1));

        jButton1.setFont(new java.awt.Font("Droid Sans", 0, 11)); // NOI18N
        jButton1.setText("Salir");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jPanel2.add(jButton1, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 110, 80, 40));

        jPanel1.add(jPanel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(440, 160, 140, 180));

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 642, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 492, Short.MAX_VALUE)
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void treFormatoValueChanged(javax.swing.event.TreeSelectionEvent evt) {//GEN-FIRST:event_treFormatoValueChanged
        String miRuta="";
        Object[] paths = treFormato.getSelectionPath().getPath();
        for (int i=0; i<paths.length; i++) 
        {
            miRuta += paths[i];
            if (i+1 <paths.length ) 
            {
                miRuta += File.separator;
            }
        }
        aux = new File(miRuta); 
        rutaOrigen = rutaFormato + File.separator + aux.getName();
        System.out.println("ruta origen: "+rutaOrigen);
        btnDescargar.setEnabled(true);
        
    }//GEN-LAST:event_treFormatoValueChanged

    private void btnDescargarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDescargarActionPerformed
        
        JFileChooser se = new JFileChooser();
        se.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);        
        int estado = se.showOpenDialog(se);        
        if(estado == JFileChooser.APPROVE_OPTION)
        {             
            rutaDestino = se.getSelectedFile().getAbsolutePath();            
        } 
        
        System.out.println("Destino: "+rutaDestino);
        System.out.println("Origen: "+rutaOrigen);
        try 
        {
            //do
            Path from = Paths.get(rutaOrigen);
            Path to = Paths.get(rutaDestino+File.separator+aux.getName());
            //sobreescribir el fichero de destino, si existe, y copiar
            // los atributos, incluyendo los permisos rwx
            CopyOption[] options = new CopyOption[] {

                StandardCopyOption.REPLACE_EXISTING,
                StandardCopyOption.COPY_ATTRIBUTES

            };      

            Files.copy(from, to, options);
            
            //se abre la carpeta
            File dir = new File(rutaDestino);
            if (Desktop.isDesktopSupported()) 
            {
                try
                {
                    Desktop.getDesktop().open(dir);
                } catch (IOException ex) {
                    Logger.getLogger(FrmEntregables.class.getName()).log(Level.SEVERE, null, ex);
                }
            }
                         
        } catch (IOException ex) {
            Logger.getLogger(FrmEntregablesDocente.class.getName()).log(Level.SEVERE, null, ex);
        }
        
    }//GEN-LAST:event_btnDescargarActionPerformed

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed
        this.dispose();
    }//GEN-LAST:event_jButton1ActionPerformed

    private String cargarRaizFormato() {
        
        con = ClsConexion.getConection();
        ClsRaices raiz = new ClsRaices();
        String texto="";        
        try 
        {
            texto = raiz.SeleccionarRaizFormato(con);            
            
        } catch (Exception ex) {
            Logger.getLogger(FrmEntregables.class.getName()).log(Level.SEVERE, null, ex);
        }finally{
            ClsConexion.closeConnection(con);
        }
                  
        return texto;
    }
    
    private void actualizarArbolFormato(String xNombre,String xRuta) {
        JTreeFile jtf = new JTreeFile();
        jtf.setJTree(treFormato);
        jtf.init(xNombre,xRuta);
    }
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnDescargar;
    private javax.swing.JButton jButton1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTree treFormato;
    // End of variables declaration//GEN-END:variables
}
